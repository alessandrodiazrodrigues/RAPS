<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal RAPS - Prevent Senior | Dashboard v6.0</title>
    
    <!-- Google Fonts - Poppins Bold -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <!-- Leaflet (Mapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            padding: 0;
            color: #e2e8f0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: #1e293b;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .hamburger {
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.3s;
            color: #e2e8f0;
        }

        .hamburger:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .header-left h1 {
            margin: 0;
            font-size: 22px;
            color: #60a5fa;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .badge {
            background: #48bb78;
            color: white;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .version {
            background: #60a5fa;
            color: white;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .side-menu {
            position: fixed;
            left: -280px;
            top: 0;
            width: 280px;
            height: 100vh;
            background: #1e293b;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.2);
            transition: left 0.3s ease;
            z-index: 2000;
            overflow-y: auto;
        }

        .side-menu.open {
            left: 0;
        }

        .menu-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menu-header h2 {
            margin: 0;
            color: #60a5fa;
            font-size: 20px;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
        }

        .menu-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: background 0.3s;
        }

        .menu-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .menu-items {
            padding: 20px 0;
        }

        .side-menu-item {
            display: block;
            padding: 12px 20px;
            color: #e2e8f0;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
        }

        .side-menu-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: #60a5fa;
        }

        .side-menu-item.active {
            background: rgba(96, 165, 250, 0.1);
            border-left-color: #60a5fa;
            color: #60a5fa;
        }

        .menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1500;
        }

        .side-menu.open ~ .menu-overlay {
            display: block;
        }

        .content {
            background: #0f172a;
            border-radius: 0;
            padding: 30px;
            min-height: calc(100vh - 80px);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 28px;
            color: #e2e8f0;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 3px solid #60a5fa;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }

        .kpis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .kpi-card {
            background: #1e293b;
            color: white;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid rgba(96, 165, 250, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            position: relative;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(96, 165, 250, 0.3);
            border-color: #60a5fa;
        }

        .kpi-label {
            font-size: 14px;
            color: #9ca3af;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .kpi-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #60a5fa;
        }

        .kpi-subtitle {
            font-size: 13px;
            color: #9ca3af;
            font-weight: 400;
        }

        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: rgba(96, 165, 250, 0.2);
            border-radius: 50%;
            font-size: 12px;
            cursor: help;
            position: relative;
            color: #60a5fa;
        }

        .tooltip-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            white-space: normal;
            width: 280px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            margin-bottom: 8px;
            line-height: 1.4;
            font-weight: normal;
            border: 1px solid rgba(96, 165, 250, 0.3);
        }

        .tooltip-icon:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1e293b;
            margin-bottom: 2px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-container {
            background: #1e293b;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-canvas {
            position: relative;
            height: 350px;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-title {
            font-size: 20px;
            font-weight: 600;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-filters {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-input, .filter-select {
            padding: 8px 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: #0f172a;
            border-radius: 8px;
            font-size: 14px;
            color: #e2e8f0;
            font-family: 'Poppins', sans-serif;
            min-width: 200px;
        }

        .filter-select {
            min-width: 150px;
            cursor: pointer;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #0f172a;
            border-radius: 8px;
            overflow: hidden;
        }

        thead {
            background: #60a5fa;
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 700;
            font-size: 14px;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
        }

        tbody tr:hover {
            background: rgba(96, 165, 250, 0.05);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .zona-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .zona-centro-sul { background: #60a5fa; color: #fff; }
        .zona-leste { background: #10b981; color: #fff; }
        .zona-norte { background: #f59e0b; color: #fff; }
        .zona-oeste { background: #8b5cf6; color: #fff; }
        .zona-abc { background: #ec4899; color: #fff; }

        .zonas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .zona-card {
            background: #1e293b;
            border: 2px solid rgba(96, 165, 250, 0.2);
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .zona-card:hover {
            border-color: #60a5fa;
            box-shadow: 0 8px 20px rgba(96, 165, 250, 0.3);
            transform: translateY(-5px);
        }

        .zona-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .zona-card-title {
            font-size: 22px;
            font-weight: 700;
            color: #60a5fa;
        }

        .zona-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .zona-stat {
            background: #0f172a;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .zona-stat-label {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 5px;
            font-weight: 400;
        }

        .zona-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #60a5fa;
        }

        .zona-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .zona-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            margin-bottom: 12px;
        }

        .faixa-etaria-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 13px;
        }

        .faixa-etaria-label {
            color: #9ca3af;
        }

        .faixa-etaria-value {
            font-weight: 600;
            color: #e2e8f0;
        }

        .programa-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #0f172a;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .programa-nome {
            color: #9ca3af;
            font-weight: 500;
        }

        .programa-total {
            font-weight: 700;
            color: #60a5fa;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: #60a5fa;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #60a5fa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 400;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid #f59e0b;
            color: #fbbf24;
        }

        .alert-info {
            background: rgba(96, 165, 250, 0.1);
            border-left: 4px solid #60a5fa;
            color: #60a5fa;
        }

        button, .btn-primary {
            background: #60a5fa;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover, .btn-primary:hover {
            background: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(96, 165, 250, 0.4);
        }

        .footer {
            background: #1e293b;
            padding: 20px;
            text-align: center;
            color: #9ca3af;
            font-size: 13px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 400;
            margin-top: 40px;
        }

        .footer p {
            margin: 5px 0;
        }

        .footer strong {
            color: #60a5fa;
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            .header-left h1 {
                font-size: 18px;
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .zonas-grid {
                grid-template-columns: 1fr;
            }
            .kpis {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header id="mainHeader" class="header">
        <div class="header-left">
            <span class="hamburger" onclick="toggleMenu()">☰</span>
            <h1>Portal RAPS - Prevent Senior</h1>
        </div>
        <div class="header-right">
            <span class="badge" id="badge-status">Carregando...</span>
            <span class="version">v6.0</span>
        </div>
    </header>

    <aside id="sideMenu" class="side-menu">
        <div class="menu-header">
            <h2>Menu</h2>
            <button class="menu-close" onclick="toggleMenu()">×</button>
        </div>
        <nav class="menu-items">
            <a href="#" class="side-menu-item active" data-section="dashboard" onclick="selectTab('dashboard')">Dashboard</a>
            <a href="#" class="side-menu-item" data-section="demografia" onclick="selectTab('demografia')">Demografia</a>
            <a href="#" class="side-menu-item" data-section="programas" onclick="selectTab('programas')">Programas</a>
            <a href="#" class="side-menu-item" data-section="planos" onclick="selectTab('planos')">Planos</a>
            <a href="#" class="side-menu-item" data-section="zonas" onclick="selectTab('zonas')">Zonas</a>
            <a href="#" class="side-menu-item" data-section="hospitais" onclick="selectTab('hospitais')">Hospitais</a>
            <a href="#" class="side-menu-item" data-section="perifericos" onclick="selectTab('perifericos')">Bairros Periféricos</a>
        </nav>
    </aside>

    <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>

    <div class="container">
        <div class="content">
            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <h2>Carregando dados...</h2>
                <p>Aguarde enquanto processamos 412.651 beneficiários</p>
            </div>

            <div id="dashboard" class="section">
                <h2 class="section-title">Dashboard Executivo</h2>
                <div class="kpis" id="dashboard-kpis"></div>
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">Distribuição por Faixas de Distância</div>
                        <div class="chart-canvas"><canvas id="chartFaixas"></canvas></div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Top 15 Bairros</div>
                        <div class="chart-canvas"><canvas id="chartTopBairros"></canvas></div>
                    </div>
                </div>
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Top 15 Bairros - Detalhamento</div>
                    </div>
                    <div id="tableTopBairros"></div>
                </div>
            </div>

            <div id="demografia" class="section">
                <h2 class="section-title">Análise Demográfica</h2>
                <div class="kpis" id="demografia-kpis"></div>
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">Distribuição por Faixas Etárias (Perfil 80-)</div>
                        <div class="chart-canvas"><canvas id="chartFaixas80menos"></canvas></div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Distribuição por Faixas Etárias (Perfil 80+)</div>
                        <div class="chart-canvas"><canvas id="chartFaixas80mais"></canvas></div>
                    </div>
                </div>
            </div>

            <div id="programas" class="section">
                <h2 class="section-title">Análise de Programas de Saúde</h2>
                <div class="alert alert-info">Importante: Um beneficiário pode estar em múltiplos programas simultaneamente.</div>
                <div class="kpis" id="programas-kpis"></div>
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">Top 10 Programas Mais Procurados</div>
                        <div class="chart-canvas"><canvas id="chartTopProgramas"></canvas></div>
                    </div>
                </div>
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Todos os Programas (26 categorias)</div>
                    </div>
                    <div id="tableProgramas"></div>
                </div>
            </div>

            <div id="planos" class="section">
                <h2 class="section-title">Análise de Planos de Saúde</h2>
                <div class="kpis" id="planos-kpis"></div>
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">Top 10 Planos Mais Contratados</div>
                        <div class="chart-canvas"><canvas id="chartTopPlanos"></canvas></div>
                    </div>
                </div>
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Todos os Planos (61 tipos)</div>
                        <div class="table-filters">
                            <input type="text" id="filterPlanos" class="filter-input" placeholder="Buscar plano...">
                        </div>
                    </div>
                    <div id="tablePlanos"></div>
                </div>
            </div>

            <div id="zonas" class="section">
                <h2 class="section-title">Análise por Zona Geográfica</h2>
                <div class="alert alert-info">Atualização: A zona Centro foi consolidada em Centro-Sul. Agora trabalhamos com 5 zonas principais.</div>
                <div id="zonas-grid" class="zonas-grid"></div>
            </div>

            <div id="hospitais" class="section">
                <h2 class="section-title">Análise por Hospital</h2>
                <div class="kpis" id="hospitais-kpis"></div>
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Ranking de Hospitais por Cobertura</div>
                    </div>
                    <div id="tableHospitais"></div>
                </div>
            </div>

            <div id="perifericos" class="section">
                <h2 class="section-title">Análise de Bairros Periféricos</h2>
                <div class="alert alert-warning">Critério: Top 50 bairros mais distantes do hospital credenciado mais próximo.</div>
                <div class="kpis" id="perifericos-kpis"></div>
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Top 50 Bairros Mais Distantes</div>
                        <div class="table-filters">
                            <input type="text" id="filterTop50" class="filter-input" placeholder="Buscar bairro...">
                            <select id="sortTop50" class="filter-select">
                                <option value="distancia">Ordenar por: Distância</option>
                                <option value="beneficiarios">Ordenar por: Beneficiários</option>
                                <option value="bairro">Ordenar por: Bairro (A-Z)</option>
                            </select>
                        </div>
                    </div>
                    <div id="tableTop50Distantes"></div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p><strong>Portal RAPS v6.0</strong> | Prevent Senior | Dados atualizados em Novembro 2025</p>
            <p>Desenvolvido por Alessandro Diaz Rodrigues</p>
        </div>
    </div>

    <script>
        const GITHUB_USER = 'alessandrodiazrodrigues';
        const REPO = 'RAPS';
        const BRANCH = 'main';
        const DATA_URL = `https://raw.githubusercontent.com/${GITHUB_USER}/${REPO}/${BRANCH}`;

        let dados = {};
        let charts = {};

        function toggleMenu() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('menuOverlay');
            menu.classList.toggle('open');
            overlay.style.display = menu.classList.contains('open') ? 'block' : 'none';
        }

        function selectTab(sectionId) {
            document.querySelectorAll('.side-menu-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
            toggleMenu();
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }

        async function carregarDados() {
            try {
                console.log('Carregando dados...');
                const [dashboard, demografico, programas, planos, zonas, hospitais, distancias, top50] = await Promise.all([
                    fetch(`${DATA_URL}/dashboard.json`).then(r => r.json()),
                    fetch(`${DATA_URL}/demografico.json`).then(r => r.json()),
                    fetch(`${DATA_URL}/programas.json`).then(r => r.json()),
                    fetch(`${DATA_URL}/planos.json`).then(r => r.json()),
                    fetch(`${DATA_URL}/zonas.json`).then(r => r.json()),
                    fetch(`${DATA_URL}/hospitais.json`).then(r => r.json()),
                    fetch(`${DATA_URL}/distancias.json`).then(r => r.json()),
                    fetch(`${DATA_URL}/top_50_mais_distantes.json`).then(r => r.json())
                ]);

                const perifericos = {
                    metadata: top50.metadata,
                    top_10_mais_distantes: top50.bairros.slice(0, 10),
                    todos_bairros: top50.bairros
                };

                dados = { dashboard, demografico, programas, planos, zonas, hospitais, distancias, perifericos };
                console.log('Dados carregados:', dados);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                document.getElementById('badge-status').textContent = 'DADOS REAIS';
                document.getElementById('badge-status').style.background = '#48bb78';

                renderizarTudo();
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('loading').innerHTML = `<div class="loading-spinner"></div><h2 style="color: #e53e3e;">Erro ao carregar dados</h2><p>${error.message}</p>`;
            }
        }

        function renderizarTudo() {
            try { renderizarDashboard(); console.log('Dashboard OK'); } catch (e) { console.error('Erro Dashboard:', e); }
            try { renderizarDemografia(); console.log('Demografia OK'); } catch (e) { console.error('Erro Demografia:', e); }
            try { renderizarProgramas(); console.log('Programas OK'); } catch (e) { console.error('Erro Programas:', e); }
            try { renderizarPlanos(); console.log('Planos OK'); } catch (e) { console.error('Erro Planos:', e); }
            try { renderizarZonas(); console.log('Zonas OK'); } catch (e) { console.error('Erro Zonas:', e); }
            try { renderizarHospitais(); console.log('Hospitais OK'); } catch (e) { console.error('Erro Hospitais:', e); }
            try { renderizarPerifericos(); console.log('Perifericos OK'); } catch (e) { console.error('Erro Perifericos:', e); }
        }

        function renderizarDashboard() {
            const { kpis_gerais, distribuicao_faixas, top_bairros, bairros_descobertos } = dados.dashboard;
            document.getElementById('dashboard-kpis').innerHTML = `
                <div class="kpi-card"><div class="kpi-label">Total de Beneficiários</div><div class="kpi-value">${kpis_gerais.total_beneficiarios.toLocaleString('pt-BR')}</div><div class="kpi-subtitle">em 5 zonas</div></div>
                <div class="kpi-card"><div class="kpi-label">Total de Bairros</div><div class="kpi-value">${kpis_gerais.total_bairros.toLocaleString('pt-BR')}</div><div class="kpi-subtitle">normalizados</div></div>
                <div class="kpi-card"><div class="kpi-label">Total de Hospitais</div><div class="kpi-value">${kpis_gerais.total_hospitais}</div><div class="kpi-subtitle">credenciados</div></div>
                <div class="kpi-card"><div class="kpi-label">Distância Média</div><div class="kpi-value">${kpis_gerais.distancia_media_km} km</div><div class="kpi-subtitle">até hospital mais próximo</div></div>
                <div class="kpi-card"><div class="kpi-label">Cobertura 15km</div><div class="kpi-value">${kpis_gerais.cobertura_15km_pct}%</div><div class="kpi-subtitle">${bairros_descobertos ? bairros_descobertos.total_beneficiarios.toLocaleString('pt-BR') : '0'} fora</div></div>
            `;

            const ctxFaixas = document.getElementById('chartFaixas').getContext('2d');
            if (charts.faixas) charts.faixas.destroy();
            charts.faixas = new Chart(ctxFaixas, {
                type: 'bar',
                data: {
                    labels: Object.keys(distribuicao_faixas),
                    datasets: [{ label: 'Bairros', data: Object.values(distribuicao_faixas), backgroundColor: ['#60a5fa', '#3b82f6', '#2563eb', '#1d4ed8', '#1e40af'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false, labels: { color: '#e2e8f0' } } }, scales: { y: { beginAtZero: true, ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } } } }
            });

            const ctxTopBairros = document.getElementById('chartTopBairros').getContext('2d');
            if (charts.topBairros) charts.topBairros.destroy();
            charts.topBairros = new Chart(ctxTopBairros, {
                type: 'bar',
                data: {
                    labels: top_bairros.map(b => b.bairro),
                    datasets: [{ label: 'Beneficiários', data: top_bairros.map(b => b.beneficiarios), backgroundColor: '#60a5fa' }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false, labels: { color: '#e2e8f0' } } }, scales: { x: { beginAtZero: true, ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, y: { ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } } } }
            });

            document.getElementById('tableTopBairros').innerHTML = `<table><thead><tr><th>#</th><th>Bairro</th><th>Zona</th><th>Beneficiários</th><th>Hospital</th><th>Distância</th></tr></thead><tbody>${top_bairros.map((b, i) => `<tr><td><strong>${i + 1}</strong></td><td>${b.bairro}</td><td><span class="zona-badge zona-${b.zona.toLowerCase().replace(' ', '-')}">${b.zona}</span></td><td><strong>${b.beneficiarios.toLocaleString('pt-BR')}</strong></td><td>${b.hospital_proximo}</td><td>${b.distancia_km} km</td></tr>`).join('')}</tbody></table>`;
        }

        function renderizarDemografia() {
            const { kpis, faixas_etarias } = dados.demografico;
            document.getElementById('demografia-kpis').innerHTML = `
                <div class="kpi-card"><div class="kpi-label">Idade Média (18+)</div><div class="kpi-value">${kpis.idade_media_adultos_18plus}</div><div class="kpi-subtitle">anos</div></div>
                <div class="kpi-card"><div class="kpi-label">Feminino</div><div class="kpi-value">${kpis.pct_feminino}%</div><div class="kpi-subtitle">${Math.round(dados.dashboard.kpis_gerais.total_beneficiarios * parseFloat(kpis.pct_feminino) / 100).toLocaleString('pt-BR')} benef.</div></div>
                <div class="kpi-card"><div class="kpi-label">Masculino</div><div class="kpi-value">${kpis.pct_masculino}%</div><div class="kpi-subtitle">${Math.round(dados.dashboard.kpis_gerais.total_beneficiarios * parseFloat(kpis.pct_masculino) / 100).toLocaleString('pt-BR')} benef.</div></div>
                <div class="kpi-card"><div class="kpi-label">Idosos 75+</div><div class="kpi-value">${kpis.total_idosos_75plus.toLocaleString('pt-BR')}</div><div class="kpi-subtitle">${((kpis.total_idosos_75plus / dados.dashboard.kpis_gerais.total_beneficiarios) * 100).toFixed(1)}% do total</div></div>
                <div class="kpi-card"><div class="kpi-label">Idosos 80+</div><div class="kpi-value">${kpis.total_idosos_80plus.toLocaleString('pt-BR')}</div><div class="kpi-subtitle">${((kpis.total_idosos_80plus / dados.dashboard.kpis_gerais.total_beneficiarios) * 100).toFixed(1)}% do total</div></div>
            `;

            const ctx80menos = document.getElementById('chartFaixas80menos').getContext('2d');
            if (charts.faixas80menos) charts.faixas80menos.destroy();
            charts.faixas80menos = new Chart(ctx80menos, {
                type: 'doughnut',
                data: {
                    labels: ['18-49 anos', '50-69 anos', '70-74 anos', '75-79 anos'],
                    datasets: [{ data: [faixas_etarias.perfil_80_menos.faixas['18_a_49'], faixas_etarias.perfil_80_menos.faixas['50_a_69'], faixas_etarias.perfil_80_menos.faixas['70_a_74'], faixas_etarias.perfil_80_menos.faixas['75_a_79']], backgroundColor: ['#60a5fa', '#3b82f6', '#2563eb', '#1d4ed8'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#e2e8f0' } } } }
            });

            const ctx80mais = document.getElementById('chartFaixas80mais').getContext('2d');
            if (charts.faixas80mais) charts.faixas80mais.destroy();
            charts.faixas80mais = new Chart(ctx80mais, {
                type: 'doughnut',
                data: {
                    labels: ['80-89 anos', '90-94 anos', '95-99 anos', '100+ anos'],
                    datasets: [{ data: [faixas_etarias.perfil_80_mais.faixas['80_a_89'], faixas_etarias.perfil_80_mais.faixas['90_a_94'], faixas_etarias.perfil_80_mais.faixas['95_a_99'], faixas_etarias.perfil_80_mais.faixas['100_ou_mais']], backgroundColor: ['#8b5cf6', '#7c3aed', '#6d28d9', '#5b21b6'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#e2e8f0' } } } }
            });
        }

        function renderizarProgramas() {
            if (!dados.programas?.programas) return;
            const { programas, top_10 } = dados.programas;
            const semPrograma = programas.find(p => p.nome === 'SEM PROGRAMA');
            const comPrograma = dados.dashboard.kpis_gerais.total_beneficiarios - (semPrograma ? semPrograma.total : 0);

            document.getElementById('programas-kpis').innerHTML = `
                <div class="kpi-card"><div class="kpi-label">Total de Programas</div><div class="kpi-value">${programas.length}</div><div class="kpi-subtitle">categorias ativas</div></div>
                <div class="kpi-card"><div class="kpi-label">Sem Programa</div><div class="kpi-value">${semPrograma ? semPrograma.total.toLocaleString('pt-BR') : '0'}</div><div class="kpi-subtitle">${semPrograma ? semPrograma.percentual : '0'}% total</div></div>
                <div class="kpi-card"><div class="kpi-label">Com Programa</div><div class="kpi-value">${comPrograma.toLocaleString('pt-BR')}</div><div class="kpi-subtitle">${((comPrograma / dados.dashboard.kpis_gerais.total_beneficiarios) * 100).toFixed(1)}% total</div></div>
            `;

            const ctxTopProgramas = document.getElementById('chartTopProgramas').getContext('2d');
            if (charts.topProgramas) charts.topProgramas.destroy();
            charts.topProgramas = new Chart(ctxTopProgramas, {
                type: 'bar',
                data: { labels: top_10.map(p => p.nome), datasets: [{ label: 'Beneficiários', data: top_10.map(p => p.total), backgroundColor: '#60a5fa' }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false, labels: { color: '#e2e8f0' } } }, scales: { x: { beginAtZero: true, ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, y: { ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } } } }
            });

            document.getElementById('tableProgramas').innerHTML = `<table><thead><tr><th>#</th><th>Programa</th><th>Beneficiários</th><th>%</th></tr></thead><tbody>${programas.map((p, i) => `<tr><td>${i + 1}</td><td><strong>${p.nome}</strong></td><td>${p.total.toLocaleString('pt-BR')}</td><td>${p.percentual}%</td></tr>`).join('')}</tbody></table>`;
        }

        function renderizarPlanos() {
            if (!dados.planos?.kpis) return;
            const { kpis, todos_planos, top_10_geral } = dados.planos;

            document.getElementById('planos-kpis').innerHTML = `
                <div class="kpi-card"><div class="kpi-label">Total de Planos</div><div class="kpi-value">${kpis.total_planos_unicos}</div><div class="kpi-subtitle">tipos diferentes</div></div>
                <div class="kpi-card"><div class="kpi-label">Plano Mais Comum</div><div class="kpi-value">${kpis.plano_mais_comum}</div><div class="kpi-subtitle">${kpis.pct_plano_mais_comum}% benef.</div></div>
                <div class="kpi-card"><div class="kpi-label">Top 5 Planos</div><div class="kpi-value">${kpis.total_top_5.toLocaleString('pt-BR')}</div><div class="kpi-subtitle">${((kpis.total_top_5 / kpis.total_beneficiarios) * 100).toFixed(1)}% total</div></div>
            `;

            const ctxTopPlanos = document.getElementById('chartTopPlanos').getContext('2d');
            if (charts.topPlanos) charts.topPlanos.destroy();
            charts.topPlanos = new Chart(ctxTopPlanos, {
                type: 'bar',
                data: { labels: top_10_geral.map(p => p.nome), datasets: [{ label: 'Beneficiários', data: top_10_geral.map(p => p.total), backgroundColor: '#60a5fa' }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false, labels: { color: '#e2e8f0' } } }, scales: { x: { beginAtZero: true, ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, y: { ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } } } }
            });

            renderizarTabelaPlanos(todos_planos);
            document.getElementById('filterPlanos').addEventListener('input', (e) => {
                const filtrados = todos_planos.filter(p => p.nome.toLowerCase().includes(e.target.value.toLowerCase()));
                renderizarTabelaPlanos(filtrados);
            });
        }

        function renderizarTabelaPlanos(planos) {
            document.getElementById('tablePlanos').innerHTML = `<table><thead><tr><th>#</th><th>Plano</th><th>Beneficiários</th><th>%</th></tr></thead><tbody>${planos.map((p, i) => `<tr><td>${i + 1}</td><td><strong>${p.nome}</strong></td><td>${p.total.toLocaleString('pt-BR')}</td><td>${p.percentual}%</td></tr>`).join('')}</tbody></table>`;
        }

        function renderizarZonas() {
            if (!dados.zonas?.zonas) return;
            const { zonas } = dados.zonas;

            document.getElementById('zonas-grid').innerHTML = zonas.map(zona => `
                <div class="zona-card">
                    <div class="zona-card-header">
                        <h3 class="zona-card-title">${zona.nome}</h3>
                        <span class="zona-badge zona-${zona.nome.toLowerCase().replace(' ', '-')}">${zona.beneficiarios.toLocaleString('pt-BR')}</span>
                    </div>
                    <div class="zona-stats">
                        <div class="zona-stat"><div class="zona-stat-label">Bairros</div><div class="zona-stat-value">${zona.bairros}</div></div>
                        <div class="zona-stat"><div class="zona-stat-label">Idade Média</div><div class="zona-stat-value">${zona.idade_media_adultos} anos</div></div>
                        <div class="zona-stat"><div class="zona-stat-label">Feminino</div><div class="zona-stat-value">${zona.pct_feminino}%</div></div>
                        <div class="zona-stat"><div class="zona-stat-label">Masculino</div><div class="zona-stat-value">${zona.pct_masculino}%</div></div>
                        <div class="zona-stat"><div class="zona-stat-label">Idosos 80+</div><div class="zona-stat-value">${zona.idosos_80plus.toLocaleString('pt-BR')}</div></div>
                        <div class="zona-stat"><div class="zona-stat-label">Dist. Média</div><div class="zona-stat-value">${zona.distancia_media_km} km</div></div>
                    </div>
                    <div class="zona-section">
                        <div class="zona-section-title">Distribuição Etária (8 faixas)</div>
                        ${['18_a_49', '50_a_69', '70_a_74', '75_a_79', '80_a_89', '90_a_94', '95_a_99', '100_ou_mais'].map(f => {
                            const label = f.replace('_', '-').replace('ou_mais', '+');
                            return `<div class="faixa-etaria-item"><span class="faixa-etaria-label">${label} anos:</span><span class="faixa-etaria-value">${zona.faixas_etarias[f].total.toLocaleString('pt-BR')} (${zona.faixas_etarias[f].percentual}%)</span></div>`;
                        }).join('')}
                    </div>
                    <div class="zona-section">
                        <div class="zona-section-title">Top 4 Programas</div>
                        ${zona.top_programas.map((p, i) => `<div class="programa-item"><span class="programa-nome">${i + 1}. ${p.nome}</span><span class="programa-total">${p.total.toLocaleString('pt-BR')}</span></div>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderizarHospitais() {
            if (!dados.hospitais?.hospitais) return;
            const { hospitais } = dados.hospitais;
            const maiorCobertura = hospitais[0];

            document.getElementById('hospitais-kpis').innerHTML = `
                <div class="kpi-card"><div class="kpi-label">Total de Hospitais</div><div class="kpi-value">${hospitais.length}</div><div class="kpi-subtitle">na rede</div></div>
                <div class="kpi-card"><div class="kpi-label">Maior Cobertura</div><div class="kpi-value">${maiorCobertura.nome}</div><div class="kpi-subtitle">${maiorCobertura.bairros_cobertos} bairros</div></div>
            `;

            document.getElementById('tableHospitais').innerHTML = `<table><thead><tr><th>#</th><th>Hospital</th><th>Zona</th><th>Bairros</th><th>Beneficiários</th><th>% Rede</th></tr></thead><tbody>${hospitais.map((h, i) => `<tr><td><strong>${i + 1}</strong></td><td><strong>${h.nome}</strong></td><td><span class="zona-badge zona-${h.zona.toLowerCase().replace(' ', '-')}">${h.zona}</span></td><td>${h.bairros_cobertos}</td><td><strong>${h.beneficiarios.toLocaleString('pt-BR')}</strong></td><td>${h.percentual_rede}%</td></tr>`).join('')}</tbody></table>`;
        }

        function renderizarPerifericos() {
            if (!dados.perifericos?.metadata) return;
            const { metadata, todos_bairros } = dados.perifericos;

            document.getElementById('perifericos-kpis').innerHTML = `
                <div class="kpi-card"><div class="kpi-label">Total de Bairros</div><div class="kpi-value">${metadata.total_bairros}</div><div class="kpi-subtitle">mais distantes</div></div>
                <div class="kpi-card"><div class="kpi-label">Beneficiários Afetados</div><div class="kpi-value">${metadata.total_beneficiarios.toLocaleString('pt-BR')}</div><div class="kpi-subtitle">${((metadata.total_beneficiarios / 412651) * 100).toFixed(1)}% rede</div></div>
                <div class="kpi-card"><div class="kpi-label">Distância Média</div><div class="kpi-value">${metadata.distancia_media_km} km</div><div class="kpi-subtitle">até hospital</div></div>
                <div class="kpi-card"><div class="kpi-label">Tempo Médio</div><div class="kpi-value">${metadata.tempo_medio_min} min</div><div class="kpi-subtitle">deslocamento</div></div>
            `;

            renderizarTabelaTop50(todos_bairros);

            document.getElementById('filterTop50').addEventListener('input', (e) => {
                const filtrados = todos_bairros.filter(b => b.bairro.toLowerCase().includes(e.target.value.toLowerCase()));
                renderizarTabelaTop50(filtrados);
            });

            document.getElementById('sortTop50').addEventListener('change', (e) => {
                let ordenados = [...todos_bairros];
                if (e.target.value === 'distancia') ordenados.sort((a, b) => b.distancia_km - a.distancia_km);
                else if (e.target.value === 'beneficiarios') ordenados.sort((a, b) => b.beneficiarios - a.beneficiarios);
                else ordenados.sort((a, b) => a.bairro.localeCompare(b.bairro));
                renderizarTabelaTop50(ordenados);
            });
        }

        function renderizarTabelaTop50(bairros) {
            document.getElementById('tableTop50Distantes').innerHTML = `<table><thead><tr><th>#</th><th>Bairro</th><th>Cidade</th><th>Zona</th><th>Benef.</th><th>Hospital</th><th>Distância</th><th>Tempo</th></tr></thead><tbody>${bairros.map((b, i) => `<tr><td><strong>${i + 1}</strong></td><td>${b.bairro}</td><td>${b.cidade || 'São Paulo'}</td><td><span class="zona-badge zona-${b.zona.toLowerCase().replace(' ', '-')}">${b.zona}</span></td><td>${b.beneficiarios}</td><td>${b.hospital_mais_proximo}</td><td><strong>${b.distancia_km} km</strong></td><td>${b.tempo_formatado || b.tempo_min + ' min'}</td></tr>`).join('')}</tbody></table>`;
        }

        window.addEventListener('DOMContentLoaded', carregarDados);
    </script>
</body>
</html>
