<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal RAPS - Prevent Senior | An√°lise Completa</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .header {
            background: #1e293b;
            padding: 20px 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header h1 {
            color: #60a5fa;
            font-size: 24px;
        }

        .badge {
            background: #10b981;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            gap: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(96, 165, 250, 0.2);
            border-top-color: #60a5fa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #60a5fa;
            font-size: 18px;
            font-weight: 600;
        }

        .nav {
            background: #1e293b;
            padding: 0 30px;
            border-bottom: 2px solid rgba(96, 165, 250, 0.2);
            overflow-x: auto;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
        }

        .nav-tab {
            background: transparent;
            border: none;
            color: #94a3b8;
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-tab:hover {
            color: #e2e8f0;
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-tab.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
        }

        .content {
            padding: 30px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1e293b;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-left: 4px solid #60a5fa;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-label {
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-value {
            color: #e2e8f0;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-subtitle {
            color: #10b981;
            font-size: 13px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: #1e293b;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .chart-title {
            color: #e2e8f0;
            font-size: 18px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .table-container {
            background: #1e293b;
            border-radius: 12px;
            padding: 25px;
            overflow-x: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(96, 165, 250, 0.1);
            color: #60a5fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            position: sticky;
            top: 0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
            font-size: 14px;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .map-container {
            background: #1e293b;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .real-map {
            height: 600px;
            border-radius: 8px;
            z-index: 1;
        }

        .zona-badge {
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .zona-centro { background: #6366f1; color: white; }
        .zona-centro-sul { background: #10b981; color: white; }
        .zona-leste { background: #3b82f6; color: white; }
        .zona-norte { background: #f59e0b; color: white; }
        .zona-oeste { background: #8b5cf6; color: white; }
        .zona-abc { background: #ec4899; color: white; }

        .section-title {
            color: #60a5fa;
            font-size: 24px;
            margin-bottom: 25px;
        }

        .hospital-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .hospital-card {
            background: #1e293b;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-top: 4px solid #60a5fa;
        }

        .hospital-name {
            color: #e2e8f0;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .hospital-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .hospital-stat {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
        }

        .hospital-stat-label {
            color: #94a3b8;
            font-size: 13px;
        }

        .hospital-stat-value {
            color: #60a5fa;
            font-weight: 600;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando Portal RAPS...</div>
    </div>

    <div class="header">
        <h1>üè• Portal RAPS - Prevent Senior</h1>
        <span class="badge">‚úÖ DADOS REAIS - Nov/2025</span>
    </div>

    <div class="nav">
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showSection('demografia')">üë• Demografia</button>
            <button class="nav-tab" onclick="showSection('programas')">üìã Programas</button>
            <button class="nav-tab" onclick="showSection('zonas')">üó∫Ô∏è Zonas</button>
            <button class="nav-tab" onclick="showSection('hospitais')">üè• Hospitais</button>
            <button class="nav-tab" onclick="showSection('gaps')">‚ö†Ô∏è Gaps</button>
            <button class="nav-tab" onclick="showSection('mapa')">üó∫ Mapa</button>
        </div>
    </div>

    <div class="content" id="mainContent" style="display: none;">
        
        <!-- DASHBOARD EXECUTIVO -->
        <div id="dashboard" class="section active">
            <h2 class="section-title">üìä Vis√£o Geral da Rede</h2>
            <div class="stats-grid" id="dashboardStats"></div>
            <div class="charts-grid" id="dashboardCharts"></div>
            <div class="table-container" id="topBairros"></div>
        </div>

        <!-- AN√ÅLISE DEMOGR√ÅFICA -->
        <div id="demografia" class="section">
            <h2 class="section-title">üë• An√°lise Demogr√°fica</h2>
            <div class="stats-grid" id="demografiaStats"></div>
            <div class="charts-grid" id="demografiaCharts"></div>
        </div>

        <!-- AN√ÅLISE DE PROGRAMAS -->
        <div id="programas" class="section">
            <h2 class="section-title">üìã An√°lise de Programas</h2>
            <div class="stats-grid" id="programasStats"></div>
            <div class="charts-grid" id="programasCharts"></div>
            <div class="table-container" id="programasTabela"></div>
        </div>

        <!-- AN√ÅLISE POR ZONA -->
        <div id="zonas" class="section">
            <h2 class="section-title">üó∫Ô∏è An√°lise por Zona</h2>
            <div class="hospital-grid" id="zonasCards"></div>
            <div class="charts-grid" id="zonasCharts"></div>
        </div>

        <!-- AN√ÅLISE POR HOSPITAL -->
        <div id="hospitais" class="section">
            <h2 class="section-title">üè• An√°lise por Hospital</h2>
            <div class="table-container" id="hospitaisTabela"></div>
            <div class="charts-grid" id="hospitaisCharts"></div>
        </div>

        <!-- GAPS E OPORTUNIDADES -->
        <div id="gaps" class="section">
            <h2 class="section-title">‚ö†Ô∏è Gaps e Oportunidades</h2>
            <div class="stats-grid" id="gapsStats"></div>
            <div class="table-container" id="gapsTabela"></div>
        </div>

        <!-- MAPA GEOGR√ÅFICO -->
        <div id="mapa" class="section">
            <h2 class="section-title">üó∫ Mapa Geogr√°fico</h2>
            <div class="map-container">
                <div id="mapReal" class="real-map"></div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ÉO
        const GITHUB_USER = 'alessandrodiazrodrigues';
        const REPO = 'RAPS';
        const BRANCH = 'main';
        const DATA_URL = `https://raw.githubusercontent.com/${GITHUB_USER}/${REPO}/${BRANCH}`;

        // DADOS GLOBAIS
        let dados = {
            dashboard: null,
            demografico: null,
            programas: null,
            planos: null,
            zonas: null,
            hospitais: null,
            distancias: null,
            bairros: []
        };

        let mapInstance = null;
        let chartInstances = {};

        // CARREGAR DADOS
        async function carregarDados() {
            try {
                console.log('üîÑ Carregando dados...');
                
                const [
                    dashboard,
                    demografico,
                    programas,
                    planos,
                    zonas,
                    hospitais,
                    distancias,
                    bairrosCentro,
                    bairrosCentroSul,
                    bairrosLeste,
                    bairrosNorte,
                    bairrosOeste,
                    bairrosABC
                ] = await Promise.all([
                    fetch(`${DATA_URL}/dashboard.json`).then(r => r.json()),
                    fetch(`${DATA_URL}/demografico.json`).then(r => r.json()),
                    fetch(`${DATA_URL}/programas.json`).then(r => r.json()),
                    fetch(`${DATA_URL}/planos.json`).then(r => r.json()),
                    fetch(`${DATA_URL}/zonas.json`).then(r => r.json()),
                    fetch(`${DATA_URL}/hospitais.json`).then(r => r.json()),
                    fetch(`${DATA_URL}/distancias.json`).then(r => r.json()),
                    fetch(`${DATA_URL}/bairros_centro.json`).then(r => r.json()),
                    fetch(`${DATA_URL}/bairros_centro_sul.json`).then(r => r.json()),
                    fetch(`${DATA_URL}/bairros_leste.json`).then(r => r.json()),
                    fetch(`${DATA_URL}/bairros_norte.json`).then(r => r.json()),
                    fetch(`${DATA_URL}/bairros_oeste.json`).then(r => r.json()),
                    fetch(`${DATA_URL}/bairros_abc.json`).then(r => r.json())
                ]);

                dados.dashboard = dashboard;
                dados.demografico = demografico;
                dados.programas = programas;
                dados.planos = planos;
                dados.zonas = zonas;
                dados.hospitais = hospitais;
                dados.distancias = distancias;

                dados.bairros = [
                    ...bairrosCentro.bairros,
                    ...bairrosCentroSul.bairros,
                    ...bairrosLeste.bairros,
                    ...bairrosNorte.bairros,
                    ...bairrosOeste.bairros,
                    ...bairrosABC.bairros
                ];

                console.log('‚úÖ Dados carregados');
                renderizarTudo();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
            } catch (error) {
                console.error('‚ùå Erro:', error);
                document.querySelector('.loading-text').textContent = 'Erro ao carregar dados';
                document.querySelector('.loading-text').style.color = '#ef4444';
            }
        }

        // RENDERIZAR TUDO
        function renderizarTudo() {
            renderizarDashboard();
            renderizarDemografia();
            renderizarProgramas();
            renderizarZonas();
            renderizarHospitais();
            renderizarGaps();
        }

        // DASHBOARD
        function renderizarDashboard() {
            const { kpis_gerais, distribuicao_faixas, top_bairros } = dados.dashboard;
            
            // Stats
            document.getElementById('dashboardStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">üë• Total Benefici√°rios</div>
                    <div class="stat-value">${parseInt(kpis_gerais.total_beneficiarios).toLocaleString('pt-BR')}</div>
                    <div class="stat-subtitle">100% mapeados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìç Bairros √önicos</div>
                    <div class="stat-value">${parseInt(kpis_gerais.total_bairros).toLocaleString('pt-BR')}</div>
                    <div class="stat-subtitle">6 zonas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üè• Hospitais</div>
                    <div class="stat-value">${parseInt(kpis_gerais.total_hospitais)}</div>
                    <div class="stat-subtitle">Rede credenciada</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìè Dist√¢ncia M√©dia</div>
                    <div class="stat-value">${parseFloat(kpis_gerais.distancia_media_km).toFixed(2)} km</div>
                    <div class="stat-subtitle">Hospital mais pr√≥ximo</div>
                </div>
            `;

            // Charts
            document.getElementById('dashboardCharts').innerHTML = `
                <div class="chart-card">
                    <div class="chart-title">Distribui√ß√£o por Faixas de Dist√¢ncia</div>
                    <div class="chart-wrapper"><canvas id="chartFaixas"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Benefici√°rios por Zona</div>
                    <div class="chart-wrapper"><canvas id="chartBenefZona"></canvas></div>
                </div>
            `;

            // Gr√°fico Faixas - CORRIGIDO: valores diretos
            new Chart(document.getElementById('chartFaixas'), {
                type: 'bar',
                data: {
                    labels: Object.keys(distribuicao_faixas),
                    datasets: [{
                        label: 'Bairros',
                        data: Object.values(distribuicao_faixas),
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#f97316', '#ef4444'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        x: { 
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        }
                    }
                }
            });

            // Gr√°fico Zonas - CORRIGIDO: campo "nome"
            const zonasData = dados.zonas.zonas;
            new Chart(document.getElementById('chartBenefZona'), {
                type: 'doughnut',
                data: {
                    labels: zonasData.map(z => z.nome),
                    datasets: [{
                        data: zonasData.map(z => parseInt(z.beneficiarios)),
                        backgroundColor: ['#6366f1', '#10b981', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            position: 'bottom',
                            labels: { color: '#94a3b8' }
                        } 
                    }
                }
            });

            // Tabela Top Bairros - CORRIGIDO: campo "hospital_proximo"
            document.getElementById('topBairros').innerHTML = `
                <h3 style="color: #60a5fa; margin-bottom: 20px;">üìç Top 15 Bairros</h3>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Bairro</th>
                            <th>Zona</th>
                            <th>Benefici√°rios</th>
                            <th>Hospital Mais Pr√≥ximo</th>
                            <th>Dist√¢ncia</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${top_bairros.slice(0, 15).map((b, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${b.bairro}</td>
                                <td><span class="zona-badge zona-${normalizeZona(b.zona)}">${b.zona}</span></td>
                                <td>${parseInt(b.beneficiarios).toLocaleString('pt-BR')}</td>
                                <td>${b.hospital_proximo}</td>
                                <td>${parseFloat(b.distancia_km).toFixed(2)} km</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // DEMOGRAFIA
        function renderizarDemografia() {
            const { kpis, faixas_etarias } = dados.demografico;
            
            const idadeMedia = parseFloat(kpis.idade_media_adultos_18plus);
            const pctFem = parseFloat(kpis.pct_feminino);
            const pctMasc = parseFloat(kpis.pct_masculino);
            const totalFem = parseInt(kpis.total_feminino || dados.dashboard.kpis_gerais.total_beneficiarios * pctFem / 100);
            const totalMasc = parseInt(kpis.total_masculino || dados.dashboard.kpis_gerais.total_beneficiarios * pctMasc / 100);
            const totalIdosos = parseInt(kpis.total_idosos_80plus);
            
            // Stats
            document.getElementById('demografiaStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">üéÇ Idade M√©dia (18+)</div>
                    <div class="stat-value">${idadeMedia.toFixed(1)} anos</div>
                    <div class="stat-subtitle">Apenas adultos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üë© Feminino</div>
                    <div class="stat-value">${pctFem.toFixed(1)}%</div>
                    <div class="stat-subtitle">${totalFem.toLocaleString('pt-BR')} mulheres</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üë® Masculino</div>
                    <div class="stat-value">${pctMasc.toFixed(1)}%</div>
                    <div class="stat-subtitle">${totalMasc.toLocaleString('pt-BR')} homens</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üë¥ Idosos (‚â•80)</div>
                    <div class="stat-value">${totalIdosos.toLocaleString('pt-BR')}</div>
                    <div class="stat-subtitle">${((totalIdosos/dados.dashboard.kpis_gerais.total_beneficiarios)*100).toFixed(1)}% do total</div>
                </div>
            `;

            // Charts
            document.getElementById('demografiaCharts').innerHTML = `
                <div class="chart-card" style="grid-column: 1 / -1;">
                    <div class="chart-title">Faixas Et√°rias Detalhadas</div>
                    <div class="chart-wrapper"><canvas id="chartFaixasCompleto"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Distribui√ß√£o por G√™nero</div>
                    <div class="chart-wrapper"><canvas id="chartGenero"></canvas></div>
                </div>
            `;

            // Gr√°fico COMPLETO com todas as faixas - CORRIGIDO: valores diretos
            const perfil80Menos = faixas_etarias.perfil_80_menos.faixas;
            const perfil80Mais = faixas_etarias.perfil_80_mais.faixas;
            
            const labelsCompleto = [
                '18 a 49 anos',
                '50 a 69 anos',
                '70 a 74 anos',
                '75 a 79 anos',
                '80 a 89 anos',
                '90 a 94 anos',
                '95 a 99 anos',
                '100 ou mais'
            ];
            
            const valoresCompleto = [
                perfil80Menos['18_a_49'],
                perfil80Menos['50_a_69'],
                perfil80Menos['70_a_74'],
                perfil80Menos['75_a_79'],
                perfil80Mais['80_a_89'],
                perfil80Mais['90_a_94'],
                perfil80Mais['95_a_99'],
                perfil80Mais['100_ou_mais']
            ];

            new Chart(document.getElementById('chartFaixasCompleto'), {
                type: 'bar',
                data: {
                    labels: labelsCompleto,
                    datasets: [{
                        label: 'Benefici√°rios',
                        data: valoresCompleto,
                        backgroundColor: [
                            '#3b82f6', '#3b82f6', '#3b82f6', '#3b82f6',
                            '#f59e0b', '#f59e0b', '#f59e0b', '#f59e0b'
                        ],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        x: { 
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        }
                    }
                }
            });

            // Gr√°fico G√™nero
            new Chart(document.getElementById('chartGenero'), {
                type: 'pie',
                data: {
                    labels: [`Feminino (${pctFem.toFixed(1)}%)`, `Masculino (${pctMasc.toFixed(1)}%)`],
                    datasets: [{
                        data: [totalFem, totalMasc],
                        backgroundColor: ['#ec4899', '#3b82f6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            position: 'bottom',
                            labels: { color: '#94a3b8' }
                        } 
                    }
                }
            });
        }

        // PROGRAMAS
        function renderizarProgramas() {
            const { programas: progs, top_10 } = dados.programas;
            const totalBenef = parseInt(dados.dashboard.kpis_gerais.total_beneficiarios);
            
            const comPrograma = progs.find(p => p.nome === "SEM PROGRAMA");
            const semPrograma = comPrograma ? parseInt(comPrograma.total) : 0;
            const totalComPrograma = totalBenef - semPrograma;
            
            // Stats
            document.getElementById('programasStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">üìã Total Programas</div>
                    <div class="stat-value">${progs.length}</div>
                    <div class="stat-subtitle">Categorias</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">‚ùå Sem Programa</div>
                    <div class="stat-value">${semPrograma.toLocaleString('pt-BR')}</div>
                    <div class="stat-subtitle">${((semPrograma/totalBenef)*100).toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">‚úÖ Com Programa</div>
                    <div class="stat-value">${totalComPrograma.toLocaleString('pt-BR')}</div>
                    <div class="stat-subtitle">${((totalComPrograma/totalBenef)*100).toFixed(1)}%</div>
                </div>
            `;

            // Charts
            const top10Ativos = top_10.filter(p => p.nome !== "SEM PROGRAMA");
            
            document.getElementById('programasCharts').innerHTML = `
                <div class="chart-card" style="grid-column: 1 / -1;">
                    <div class="chart-title">Top 10 Programas ATIVOS</div>
                    <div class="chart-wrapper"><canvas id="chartTop10Programas"></canvas></div>
                </div>
            `;

            new Chart(document.getElementById('chartTop10Programas'), {
                type: 'bar',
                data: {
                    labels: top10Ativos.map(p => p.nome),
                    datasets: [{
                        label: 'Benefici√°rios',
                        data: top10Ativos.map(p => parseInt(p.total)),
                        backgroundColor: '#60a5fa',
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { 
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: { 
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        }
                    }
                }
            });

            // Tabela
            const progsAtivos = progs.filter(p => p.nome !== "SEM PROGRAMA");
            
            document.getElementById('programasTabela').innerHTML = `
                <h3 style="color: #60a5fa; margin-bottom: 20px;">üìä Todos os Programas ATIVOS</h3>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Programa</th>
                            <th>Benefici√°rios</th>
                            <th>% Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${progsAtivos.map((p, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${p.nome}</td>
                                <td>${parseInt(p.total).toLocaleString('pt-BR')}</td>
                                <td>${parseFloat(p.percentual).toFixed(1)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // ZONAS - CORRIGIDO: campo "nome" e "idade_media_adultos"
        function renderizarZonas() {
            const zonasData = dados.zonas.zonas;
            
            // Cards
            document.getElementById('zonasCards').innerHTML = zonasData.map(z => `
                <div class="hospital-card" style="border-top-color: ${getZonaColor(z.nome)};">
                    <div class="hospital-name">üìç ${z.nome}</div>
                    <div class="hospital-stats">
                        <div class="hospital-stat">
                            <span class="hospital-stat-label">üë• Benefici√°rios</span>
                            <span class="hospital-stat-value">${parseInt(z.beneficiarios).toLocaleString('pt-BR')}</span>
                        </div>
                        <div class="hospital-stat">
                            <span class="hospital-stat-label">üèòÔ∏è Bairros</span>
                            <span class="hospital-stat-value">${parseInt(z.bairros)}</span>
                        </div>
                        <div class="hospital-stat">
                            <span class="hospital-stat-label">üéÇ Idade M√©dia (18+)</span>
                            <span class="hospital-stat-value">${parseFloat(z.idade_media_adultos).toFixed(1)} anos</span>
                        </div>
                        <div class="hospital-stat">
                            <span class="hospital-stat-label">üë© Feminino</span>
                            <span class="hospital-stat-value">${parseFloat(z.pct_feminino).toFixed(1)}%</span>
                        </div>
                        <div class="hospital-stat">
                            <span class="hospital-stat-label">üë® Masculino</span>
                            <span class="hospital-stat-value">${parseFloat(z.pct_masculino).toFixed(1)}%</span>
                        </div>
                        <div class="hospital-stat">
                            <span class="hospital-stat-label">üë¥ Idosos (‚â•80)</span>
                            <span class="hospital-stat-value">${parseInt(z.idosos_80plus).toLocaleString('pt-BR')}</span>
                        </div>
                        <div class="hospital-stat">
                            <span class="hospital-stat-label">üìè Dist√¢ncia M√©dia</span>
                            <span class="hospital-stat-value">${parseFloat(z.distancia_media_km).toFixed(2)} km</span>
                        </div>
                    </div>
                </div>
            `).join('');

            // Charts
            document.getElementById('zonasCharts').innerHTML = `
                <div class="chart-card">
                    <div class="chart-title">Dist√¢ncia M√©dia por Zona</div>
                    <div class="chart-wrapper"><canvas id="chartDistZona"></canvas></div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Idade M√©dia por Zona (18+)</div>
                    <div class="chart-wrapper"><canvas id="chartIdadeZona"></canvas></div>
                </div>
            `;

            // Gr√°fico Dist√¢ncia
            new Chart(document.getElementById('chartDistZona'), {
                type: 'bar',
                data: {
                    labels: zonasData.map(z => z.nome),
                    datasets: [{
                        label: 'km',
                        data: zonasData.map(z => parseFloat(z.distancia_media_km)),
                        backgroundColor: zonasData.map(z => getZonaColor(z.nome)),
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { 
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: { 
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        }
                    }
                }
            });

            // Gr√°fico Idade
            new Chart(document.getElementById('chartIdadeZona'), {
                type: 'bar',
                data: {
                    labels: zonasData.map(z => z.nome),
                    datasets: [{
                        label: 'Anos',
                        data: zonasData.map(z => parseFloat(z.idade_media_adultos)),
                        backgroundColor: zonasData.map(z => getZonaColor(z.nome)),
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            max: 75,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        x: { 
                            ticks: { color: '#94a3b8' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // HOSPITAIS - CORRIGIDO: campo "nome"
        function renderizarHospitais() {
            const hospsData = dados.hospitais.hospitais;
            
            document.getElementById('hospitaisTabela').innerHTML = `
                <h3 style="color: #60a5fa; margin-bottom: 20px;">üè• Ranking de Hospitais</h3>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Hospital</th>
                            <th>Zona</th>
                            <th>Bairros</th>
                            <th>Benefici√°rios</th>
                            <th>% Rede</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${hospsData.map((h, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td><strong>${h.nome}</strong></td>
                                <td><span class="zona-badge zona-${normalizeZona(h.zona)}">${h.zona}</span></td>
                                <td>${parseInt(h.bairros_cobertos).toLocaleString('pt-BR')}</td>
                                <td>${parseInt(h.beneficiarios).toLocaleString('pt-BR')}</td>
                                <td>${parseFloat(h.percentual_rede).toFixed(1)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('hospitaisCharts').innerHTML = `
                <div class="chart-card" style="grid-column: 1 / -1;">
                    <div class="chart-title">Cobertura por Hospital</div>
                    <div class="chart-wrapper"><canvas id="chartHospitais"></canvas></div>
                </div>
            `;

            new Chart(document.getElementById('chartHospitais'), {
                type: 'bar',
                data: {
                    labels: hospsData.map(h => h.nome),
                    datasets: [{
                        label: 'Benefici√°rios',
                        data: hospsData.map(h => parseInt(h.beneficiarios)),
                        backgroundColor: '#60a5fa',
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { 
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        y: { 
                            ticks: { color: '#94a3b8', font: { size: 11 } },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // GAPS
        function renderizarGaps() {
            const { top_20_distantes, distribuicao_por_faixa } = dados.distancias;
            const totalBairros = parseInt(dados.dashboard.kpis_gerais.total_bairros);
            
            const bairrosDescobertos = parseInt(distribuicao_por_faixa["15-20km"].bairros) + parseInt(distribuicao_por_faixa[">20km"].bairros);
            const benef15_20 = parseInt(distribuicao_por_faixa["15-20km"].beneficiarios);
            const benefMais20 = parseInt(distribuicao_por_faixa[">20km"].beneficiarios);
            const benefDescobertos = benef15_20 + benefMais20;
            
            document.getElementById('gapsStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">‚ö†Ô∏è Bairros Descobertos</div>
                    <div class="stat-value">${bairrosDescobertos}</div>
                    <div class="stat-subtitle">${((bairrosDescobertos/totalBairros)*100).toFixed(1)}% (>15km)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üë• Benef. Afetados</div>
                    <div class="stat-value">${benefDescobertos.toLocaleString('pt-BR')}</div>
                    <div class="stat-subtitle">${((benefDescobertos/parseInt(dados.dashboard.kpis_gerais.total_beneficiarios))*100).toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìè Dist√¢ncia M√°xima</div>
                    <div class="stat-value">${parseFloat(top_20_distantes[0].distancia_km).toFixed(2)} km</div>
                    <div class="stat-subtitle">${top_20_distantes[0].bairro}</div>
                </div>
            `;

            document.getElementById('gapsTabela').innerHTML = `
                <h3 style="color: #60a5fa; margin-bottom: 20px;">üî¥ Top 20 Bairros Mais Distantes</h3>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Bairro</th>
                            <th>Zona</th>
                            <th>Benef.</th>
                            <th>Hospital</th>
                            <th>Dist√¢ncia</th>
                            <th>Tempo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${top_20_distantes.map((b, i) => `
                            <tr>
                                <td>${i + 1}</td>
                                <td>${b.bairro}</td>
                                <td><span class="zona-badge zona-${normalizeZona(b.zona)}">${b.zona}</span></td>
                                <td>${parseInt(b.beneficiarios)}</td>
                                <td>${b.hospital}</td>
                                <td>${parseFloat(b.distancia_km).toFixed(2)} km</td>
                                <td>${parseInt(b.tempo_min)} min</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // MAPA
        function renderizarMapa() {
            if (mapInstance) return;
            
            mapInstance = L.map('mapReal').setView([-23.5505, -46.6333], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(mapInstance);
            
            const hospitalIcon = L.divIcon({
                html: '<div style="background:#ef4444; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:18px; border:3px solid white; box-shadow:0 3px 10px rgba(0,0,0,0.5);">üè•</div>',
                className: '',
                iconSize: [32, 32]
            });
            
            const coordsHospitais = {
                'Hospital Cruz Azul': { lat: -23.565920, lng: -46.622154 },
                'Hospital Adventista': { lat: -23.563566, lng: -46.633928 },
                'S√£o Camilo Ipiranga': { lat: -23.583081, lng: -46.612073 },
                'Santa Clara': { lat: -23.532691, lng: -46.527272 },
                'Santa Virg√≠nia': { lat: -23.536880, lng: -46.589506 },
                'Santa Marcelina': { lat: -23.555054, lng: -46.462603 },
                'S√£o Camilo Pomp√©ia': { lat: -23.534065, lng: -46.688244 },
                'S√£o Camilo Santana': { lat: -23.487767, lng: -46.627247 },
                'Neomater': { lat: -23.669184, lng: -46.553716 }
            };
            
            dados.hospitais.hospitais.forEach(h => {
                const coords = coordsHospitais[h.nome];
                if (coords) {
                    L.marker([coords.lat, coords.lng], { icon: hospitalIcon })
                        .bindPopup(`<div style="font-family:sans-serif;"><strong style="color:#60a5fa;font-size:16px;">üè• ${h.nome}</strong><br><br><strong>Zona:</strong> ${h.zona}<br><strong>Benefici√°rios:</strong> ${h.beneficiarios.toLocaleString('pt-BR')}<br><strong>% Rede:</strong> ${h.percentual_rede}%</div>`)
                        .addTo(mapInstance);
                }
            });
        }

        // NAVEGA√á√ÉO
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
            
            if (sectionId === 'mapa' && !mapInstance) {
                setTimeout(renderizarMapa, 100);
            }
        }

        // UTILIT√ÅRIOS
        function normalizeZona(zona) {
            return zona.toLowerCase()
                .replace(/\s+/g, '-')
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '');
        }

        function getZonaColor(zona) {
            const colors = {
                'Centro': '#6366f1',
                'Centro-Sul': '#10b981',
                'Leste': '#3b82f6',
                'Norte': '#f59e0b',
                'Oeste': '#8b5cf6',
                'ABC': '#ec4899'
            };
            return colors[zona] || '#60a5fa';
        }

        // INICIALIZAR
        window.addEventListener('DOMContentLoaded', carregarDados);
    </script>
</body>
</html>
